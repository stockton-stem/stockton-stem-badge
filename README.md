# Stockton STEM Collaborative badge

## Introduction

This project provides a simple electronic device that students of varying
ability, with some supervision, should be able to assemble within about half
an hour. The targeted materials cost of each badge is less than US$10.

The printed circuit board is made to resemble the Stockton STEM logo in the
form of a badge with LEDs in place of the colored circles.

![Stockton STEM logo](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/stem.png)

The device is sophisticated enough that more advanced students should then be
able to modify its functions using the source code in this repository, the
free version of the development software and an inexpensive device programming
tool.

The board design schematics and firmware source code lives at
https://github.com/stockton-stem/stockton-stem-badge .

The Stockton STEM Collaborative page lives at
https://stockton.edu/sciences-math/stem-collaborative.html .


## Scope

Components:

* Printed circuit board.
* 8-pin microcontroller chip.
* Capacitor.
* Resistors.
* LEDs of different colors.
* Coin-cell battery.

## Progress

First approximations of code and circuit are committed to this repository.
They are far from final, but here's some pictures of the progress:

### Schematic

![Schematic](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/board-schematic.png)

### Layout

![Board layout](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/board-layout.png)

### 3D render of the board

![3D render of board](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/board-render.png)

### Working prototypes

Prototype 1 on strip-board:

![First prototype](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/prototype1.jpg)

### Board v0.1 render by OSH Park

![OSH Park v0.1 front](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/board-v0.1-osh-front.png)

![OSH Park v0.1 back](https://raw.githubusercontent.com/stockton-stem/stockton-stem-badge/master/images/board-v0.1-osh-back.png)


# System Description

The microcontroller in this project, a MicroChip PIC12LF1501, is a small 8-pin
device with a number of hardware features. It was selected for this project
specifically because of both its size and having four PWM peripherals, and
because, like many PIC devices, it is cheap and fairly power efficient.

The circuit for the project uses four differently colored LEDs (and associated
current-limiting resistors), a button, and is powered by a coin-cell battery.
Two capacitors provide decoupling and bulk storage; the latter helps reduce
smooth the otherwise bursty current draw of the LEDs from the battery. The
board has locations to optionally also provide an ICSP programming header and
pull-up resistor.

The code for this project is divided roughly across a handful of source files.
`main.c` contains the basic hardware device initialization and the interrupt
handler. `badge.c` and `badge.h` contains the code with LED patterns in it.
Various configuration details are kept in `config.h` (Peripheral setup values,
for example to setup the timers and PWMs) and `pic_config.h` (PIC startup
values).

The internal CPU clock is configured to run at 1MHz. At a later stage the
clock may be configured at a lower rate to reduce battery consumption, though
all downstream modules driven by this clock then need to be considered and
their values amended.

The four PWM peripherals drive the pins that the LEDs are wired to. Pulse-
width modulation enables the project to control the brightness of the LEDs.
Each PWM peripheral has its own duty-cycle value which sets the brightness.
The four PWM modules share the same clock input which is generated by the
Timer 2 peripheral. This is in turn sourced from the internal oscillator
though a divider. These are configured to provide a 16.26ms PWM period (about
600KHz). In future, reducing the system clock will reduce this PWM clock;
LEDs may use less, or more, power with a slower PWM period and this should
be investigated.

Timer 1 is setup to generate an interrupt every two seconds and is driven from
a seperate internal oscillator that runs at 32KHz. The interrupts are counted
and after RUN_INTERVAL seconds (see `config.h`) the project is powered off.
This involves disabling the PWM modules, turning off the LEDs, disabling any
interrupts that might wake the device prematurely and then putting the system
to sleep. In this state the processor uses the least amount of power possible;
a fresh CR2032 battery might last more than two years at this power level.

One interrupt is configured such that the push button on the board can wake
the processor from its slumber whereupon the hardware is reconfigured and
normal operation resumes.

The push button also generates an interrupt during normal operation; this does
two things:

* It resets the runtime counter, thus extending the time the project will
  run for.
* It is also used to cycle through the various LED patterns available.

To de-bounce the input from the button, Timer 0 is setup to run once when the
button interrupt fires. Timer 0 is setup to generate an interrupt in about 4ms
after being started, typically enough time for any noisy input signals from
the button to have finised; each subsequent noisy input resets the Timer 1
counter. Once the Timer 1 counter completes, its interrupt then causes the LED
pattern to cycle by incrementing the pattern number.

LED patterns are produced by a function that is expected to set the state of
the LEDs once and then return; advancing to the next LED state the next time
it is called. In this way cycling through different LED patterns is just a
matter of the dispatching code sitting in a loop and on each iteration
checking which pattern should be running and calling the appropriate function.
Presently this dispatch is performed in a `switch` statement; value `0` calls
`iterate_basic_ramp`, value `1` calls another function, etc. In future a
function table may work better.

In future, power reduction may be realized by replacing the current per-
iteration spin-style sleep (that is, the processor executes dummy instructions
in a loop until the correct amount of time has passed) with a system sleep
that is woken up by Timer 0 after N-milliseconds, though in the scheme of
things the amount of power consumed by the processor is tiny  compared to the
LEDs.


# License

MIT License

Copyright (c) 2017 Chris Luke

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
